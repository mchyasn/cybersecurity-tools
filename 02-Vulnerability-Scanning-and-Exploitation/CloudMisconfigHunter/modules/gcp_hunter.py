import requests
import logging
from colorama import Fore, Style

def run_gcp_check(api_url, output_file):
    results = []
    results.append(f"[*] GCP API Exposure Check for: {api_url}")

    try:
        response = requests.get(api_url, timeout=5)

        results.append(f"[=] Status Code: {response.status_code}")
        if response.status_code == 200:
            results.append(Fore.RED + "[+] Publicly Accessible API Endpoint!" + Style.RESET_ALL)
        elif response.status_code == 403:
            results.append(Fore.GREEN + "[âœ“] API is protected (403 Forbidden)" + Style.RESET_ALL)
        elif response.status_code == 404:
            results.append(Fore.YELLOW + "[!] API not found (404)" + Style.RESET_ALL)
        else:
            results.append(Fore.MAGENTA + f"[!] Unexpected status: {response.status_code}" + Style.RESET_ALL)

        if response.text.strip():
            preview = response.text.strip()[:300]
            results.append("[*] Response Preview:")
            results.append(preview)
        else:
            results.append("[-] No response body.")

    except requests.exceptions.RequestException as e:
        results.append(Fore.MAGENTA + f"[!] Request failed: {e}" + Style.RESET_ALL)
        logging.error(f"GCP API check error: {e}")

    with open(output_file, "w") as f:
        for line in results:
            f.write(line.replace(Fore.RED, "").replace(Fore.GREEN, "").replace(Fore.YELLOW, "")
                        .replace(Fore.MAGENTA, "").replace(Style.RESET_ALL, "") + "\n")

    print(f"[=] GCP scan results saved to {output_file}")
