import requests
import logging
from colorama import Fore, Style

def run_azure_check(container_url, output_file):
    results = []
    results.append(f"[*] Azure Blob Storage Exposure Check for: {container_url}")

    if not container_url.endswith("?restype=container&comp=list"):
        if not container_url.endswith("/"):
            container_url += "/"
        container_url += "?restype=container&comp=list"

    try:
        response = requests.get(container_url, timeout=5)

        results.append(f"[=] Status Code: {response.status_code}")
        if response.status_code == 200:
            results.append(Fore.RED + "[+] Publicly listable Azure Blob container!" + Style.RESET_ALL)
            if "<Blob>" in response.text:
                results.append("[*] Container appears to contain blobs.")
            else:
                results.append("[-] Container is public but may be empty.")
        elif response.status_code == 403:
            results.append(Fore.GREEN + "[✓] Container access denied – not public." + Style.RESET_ALL)
        elif response.status_code == 404:
            results.append(Fore.YELLOW + "[!] Container not found (404)" + Style.RESET_ALL)
        else:
            results.append(Fore.MAGENTA + f"[!] Unexpected status: {response.status_code}" + Style.RESET_ALL)

    except requests.exceptions.RequestException as e:
        results.append(Fore.MAGENTA + f"[!] Request failed: {e}" + Style.RESET_ALL)
        logging.error(f"Azure scan error: {e}")

    with open(output_file, "w") as f:
        for line in results:
            f.write(line.replace(Fore.RED, "").replace(Fore.GREEN, "").replace(Fore.YELLOW, "")
                        .replace(Fore.MAGENTA, "").replace(Style.RESET_ALL, "") + "\n")

    print(f"[=] Azure scan results saved to {output_file}")
