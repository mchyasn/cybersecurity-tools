import os
import yaml
import logging
from modules import pe_parser, entropy_calc, yara_scanner, vt_checker, indicators

logging.basicConfig(filename="logs/analysis.log", level=logging.INFO)

def analyze_file(file_path):
    logging.info(f"Analyzing {file_path}")
    pe_info = pe_parser.parse_pe(file_path)
    vt_result = vt_checker.check_virustotal(file_path)
    yara_hits = yara_scanner.scan_file_with_yara(file_path, "rules/suspicious.yar")

    entropy_scores = {}
    try:
        with open(file_path, "rb") as f:
            data = f.read()
        entropy = entropy_calc.calculate_entropy(data)
        entropy_scores["overall"] = entropy
    except Exception as e:
        entropy_scores["error"] = str(e)

    with open("config/config.yml") as f:
        config = yaml.safe_load(f)
    flags = indicators.flag_suspicious(pe_info, entropy_scores, config["entropy_threshold"])

    output = {
        "file": os.path.basename(file_path),
        "entry_point": pe_info.get("entry_point"),
        "imports": pe_info.get("imports"),
        "entropy": entropy_scores,
        "yara_matches": yara_hits,
        "vt": vt_result.get("vt_result"),
        "flags": flags
    }

    write_report(output)

def write_report(info):
    import csv
    csv_file = "output/report.csv"
    fieldnames = list(info.keys())
    write_header = not os.path.exists(csv_file)

    with open(csv_file, "a", newline="") as f:
        writer = csv.DictWriter(f, fieldnames=fieldnames)
        if write_header:
            writer.writeheader()
        writer.writerow(info)

if __name__ == "__main__":
    for fname in os.listdir("samples"):
        if fname.lower().endswith(".exe"):
            analyze_file(os.path.join("samples", fname))
