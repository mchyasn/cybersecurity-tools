def generate_rule(rule_name, hex_pattern, keywords, metadata):
    meta_section = "\n".join([f"        {k} = \"{v}\"" for k, v in metadata.items()])
    str_section = ""
    for idx, kw in enumerate(keywords):
        str_section += f"        $s{idx} = \"{kw}\" ascii\n"
    if hex_pattern:
        str_section += f"        $h1 = {{ {hex_pattern} }}\n"
    rule = f"""rule {rule_name}
{{
    meta:
{meta_section}
    strings:
{str_section.rstrip()}
    condition:
        any of them
}}"""
    return rule
