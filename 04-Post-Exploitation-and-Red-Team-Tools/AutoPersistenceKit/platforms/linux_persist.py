import os

CRON_MARKER = "# AutoPersistenceKit"
CRON_CMD = "@reboot python3 " + os.path.abspath(__file__) + "  # AutoPersistenceKit"

def install(verbose=False):
    try:
        with os.popen("crontab -l") as f:
            existing = f.read()
        if CRON_MARKER in existing:
            if verbose:
                print("[*] Persistence already present in crontab.")
            return
        new_cron = existing.strip() + "\n" + CRON_CMD + "\n"
        with os.popen("crontab -", "w") as f:
            f.write(new_cron)
        if verbose:
            print("[+] Persistence installed via crontab.")
    except Exception as e:
        if verbose:
            print(f"[!] Failed to install persistence: {e}")

def remove(verbose=False):
    try:
        with os.popen("crontab -l") as f:
            lines = f.readlines()
        new_lines = [line for line in lines if CRON_MARKER not in line]
        with os.popen("crontab -", "w") as f:
            f.writelines(new_lines)
        if verbose:
            print("[+] Persistence removed from crontab.")
    except Exception as e:
        if verbose:
            print(f"[!] Failed to remove persistence: {e}")
