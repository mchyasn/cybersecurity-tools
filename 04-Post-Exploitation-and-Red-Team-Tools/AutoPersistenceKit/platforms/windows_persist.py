import sys
if not sys.platform.startswith("win"):
    raise ImportError("winreg is only available on Windows systems.")

import os
import winreg

REG_PATH = r"Software\\Microsoft\\Windows\\CurrentVersion\\Run"
PERSIST_KEY = "AutoPersistenceKit"

def install(verbose=False):
    exe_path = os.path.abspath(__file__)
    command = f'"{exe_path}"'
    try:
        key = winreg.OpenKey(winreg.HKEY_CURRENT_USER, REG_PATH, 0, winreg.KEY_SET_VALUE)
        winreg.SetValueEx(key, PERSIST_KEY, 0, winreg.REG_SZ, command)
        winreg.CloseKey(key)
        if verbose:
            print(f"[+] Persistence installed via registry: {command}")
    except Exception as e:
        if verbose:
            print(f"[!] Failed to install persistence: {e}")

def remove(verbose=False):
    try:
        key = winreg.OpenKey(winreg.HKEY_CURRENT_USER, REG_PATH, 0, winreg.KEY_SET_VALUE)
        winreg.DeleteValue(key, PERSIST_KEY)
        winreg.CloseKey(key)
        if verbose:
            print(f"[+] Persistence removed from registry.")
    except Exception as e:
        if verbose:
            print(f"[!] Failed to remove persistence: {e}")
